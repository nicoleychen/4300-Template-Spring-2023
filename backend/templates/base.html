<!DOCTYPE html>
<title>{% block title %}{% endblock %} FindMyFragrance</title>
<link rel="icon" type="image/x-icon" href="/static/images/favicon.ico">
<link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link
  href="https://fonts.googleapis.com/css2?family=Kanit&family=Montserrat&family=Open+Sans:wght@500&display=swap"
  rel="stylesheet"
/>
<body>
  <div class="full-body-container">
    <div class="top-text">
      <div class="findMyFragrance-title">
        <h1 id="color-pink">FindMyFragrance</h1>
      </div>
      <div>
        <div class="input-box">
          <img src="{{ url_for('static', filename='images/mag.png') }}" />
          <!-- <input
          placeholder="Search for a fragrance"
          id="filter-text-val"
          style="background-color: #efe4e0"
          onkeyup="filterText()"
        /> -->
          <input
            type="text"
            placeholder="Search for a fragrance"
            id="search-text"
            style="background-color: #efe4e0; width: 400px"
          />
        </div>
        <input
          type="button"
          class="input-box"
          id="search-button"
          value="Find Fragrances"
          style="width: 150px"
        />
      </div>

      <div class="filter-buttons">
        <p>Preference:</p>
        <input type="radio" , id="male-button" , name="gender" , value="male" />
        <label for="male-button"> Male</label>
        <input type="radio", id="female-button", name="gender",value="female"/>
        <label for="female-button"> Female</label>
        <input type="radio", id="no-pref-button", name="gender", value="no preference" checked
        />
        <label for="no-pref-button"> No preference</label>
      </div>

      <div class = "filter-rating">
        <label for = "rating"> Sort by rating: </label>
        <select name = "rating" id = "rating">
          <option value = "1"> 1</option>
          <option value = "2"> 2</option>
          <option value = "3"> 3</option>
          <option value = "4"> 4</option>
        </select>
      </div>
    </div>
    <div id="result-box">
      <div class="result-heading" id="result-heading-text">Search results:</div>
    </div>
  </div>

  <script>
    // creates API request every time a gender pref is selected
    // if (document.querySelector('input[name="gender"]')) {
    //   document.querySelectorAll('input[name="gender"]').forEach((elem) => {
    //     elem.addEventListener("change", function(event) {
    //     var gender = event.target.value;
    //     fetch("/gender_pref?" + new URLSearchParams({ gender: gender }).toString())
    //     .then(function (response){
    //       return response.json();
    //     }).then(function (data) {
    //       console.log(data);
    //     }).catch(function (err){
    //       console.warn("Something went wrong.", err);
    //     });
    //      });
    //   });
    // }  
    
    const button = document.getElementById("search-button");
    console.log(button);
    button.addEventListener("click", returnResults);
    
    function returnResults() {
      // const removeText = document.getElementsByClassName("no-result");
      // removeText[0].parentNode.removeChild(removeText[0]);

      const removeBoxes = document.getElementsByClassName("result-card");
      while(removeBoxes.length > 0){
          removeBoxes[0].parentNode.removeChild(removeBoxes[0]);
      }

      let query = document.getElementById("search-text").value;
      let male_pref = document.getElementById("male-button").checked;
      let female_pref = document.getElementById("female-button").checked;
      let no_pref = document.getElementById("no-pref-button").checked;

      let gender_filter = ""
      if (male_pref){
        gender_filter = "for women"
      }else if (female_pref){
        gender_filter = "for men"
      }else{
        gender_filter = ""
      }

      document.getElementById("result-heading-text").textContent =
        'Results similar to "' + query + '":';

      //JJ: testing function -- console log true if the query exsists in the dataset & false otherwise
      // fetch("/testing?" + new URLSearchParams({ name: query }).toString())
      // .then(function (response) {
      //     // The API call was successful!
      //     return response.json();
      //   }).then(function (data) {
      //     // This is the JSON from our response
      //     console.log(data);
      //   }).catch(function (err) {
	    //     // There was an error
	    //     console.warn('Something went wrong.', err);
      //   });

      fetch("/similar?" + new URLSearchParams({ name:query, gender_pref:gender_filter}).toString())
      .then(function (response){
          // The API call was successful!
          return response.json();
        }).then(function (data) {
          // This is the JSON from our response
          console.log(data);
          const results = data;
          if (Object.values(results).length === 0) {
            console.log("NOT FOUND IN DATASET")
            let tempDiv = document.createElement("div");
            tempDiv.innerHTML = noResultTemplate();
            document.getElementById("result-box").appendChild(tempDiv);
          } else {
            results.forEach((res) => {
              let tempDiv = document.createElement("div");
              tempDiv.innerHTML = resultTemplate(
                res.img,
                res.name,
                res.brand,
                res.rating,
                res.gender,
                res.topnote,
                res.middlenote,
                res.bottomnote,
                res.desc
              );
              document.getElementById("result-box").appendChild(tempDiv);
            });
          }

        }).catch(function (err) {
	        // There was an error
	        console.warn('Something went wrong.', err);
        });
      


      // todo: call a backend endpoint here & pass the query to retrieve the top 3 results data and store them as 'results'
      // for now use a dummy data

      //   fetch("/similar?" + new URLSearchParams({ title: query }).toString())
      //   .then((response) => response.json())
      //   .then(results.forEach(res => {

      //     let tempDiv = document.createElement('div')
      //     tempDiv.innerHTML = resultTemplate(
      //       res.img,
      //       res.name,
      //       res.brand,
      //       res.notes,
      //       res.desc)
      //     document.getElementById('result-box').appendChild(tempDiv)
      // }));

      // pseudocode
      // fetch("/similar?" + new URLSearchParams({ title: query }).toString())
      // .then(response) => response.json())
      // .then(move the results.foreach here);
    }

    function resultTemplate(img, name, brand, rating, gender, topnote, middlenote, bottomnote, desc) {
      return `<div class='result-card'>
                <img src=${img} class='fragrance-img'>
                <h3 class='fragrance-name'>${name} by ${brand}</h3>
                <p class = 'fragrance-detail'> Rating: ${rating}</p> 
                <p class = 'fragrance-detail'> Gender: ${gender}</p> 
                <p class = 'fragrance-detail'> Top notes: ${topnote} </p>
                <p class = 'fragrance-detail'> Middle notes: ${middlenote} </p>
                <p class = 'fragrance-detail'> Base notes: ${bottomnote}</p>
                <p class='fragrance-detail'>Description: ${desc}</p>
            </div>`;
    }

    function noResultTemplate() {
      return `<div class = 'result-card'> No results found.</div>`;
    }
  </script>
</body>
